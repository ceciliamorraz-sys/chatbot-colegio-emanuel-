<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EmaBot â€“ Asistente Virtual</title>
  <style>
    :root{
      --brand:#1e4ed8;
      --brand2:#0ea5e9;
      --bg:#0b1220;
      --panel:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --soft:#f1f5f9;
      --ok:#22c55e;
      --danger:#ef4444;
      --shadow: 0 12px 34px rgba(2,6,23,.28);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background:
        radial-gradient(1100px 620px at 30% 10%, rgba(14,165,233,.28), transparent 52%),
        radial-gradient(900px 560px at 85% 30%, rgba(30,78,216,.25), transparent 55%),
        linear-gradient(180deg, #050816, #0b1220);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .wrap{
      width:min(440px, 100%);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      background: var(--panel);
      transform: translateY(0);
      animation: pop .35s ease-out;
    }
    @keyframes pop{
      from{transform: translateY(8px); opacity:.6}
      to{transform: translateY(0); opacity:1}
    }

    .topbar{
      padding:14px 14px;
      color:white;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      position:relative;
      overflow:hidden;
    }
    .topbar::after{
      content:"";
      position:absolute;
      inset:-60%;
      background: radial-gradient(circle at 40% 40%, rgba(255,255,255,.25), transparent 55%);
      animation: glow 3.2s ease-in-out infinite;
      transform: rotate(16deg);
      pointer-events:none;
    }
    @keyframes glow{
      0%,100%{transform: translateX(-18px) rotate(16deg); opacity:.55}
      50%{transform: translateX(18px) rotate(16deg); opacity:1}
    }

    .brand{display:flex; gap:10px; align-items:center; min-width:0; position:relative; z-index:1;}
    .avatar{
      width:38px; height:38px;
      border-radius:14px;
      background: rgba(255,255,255,.16);
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.25);
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }
    .title{line-height:1.05; min-width:0;}
    .title b{display:block; font-size:14.5px; letter-spacing:.2px}
    .title small{display:flex; align-items:center; gap:7px; font-size:12px; opacity:.94; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .dot{
      width:8px; height:8px; border-radius:50%;
      background: var(--ok);
      box-shadow:0 0 0 4px rgba(34,197,94,.18);
      animation: pulse 1.6s ease-in-out infinite;
      flex:0 0 auto;
    }
    @keyframes pulse{
      0%,100%{transform:scale(1); opacity:.9}
      50%{transform:scale(1.25); opacity:1}
    }

    .actions{display:flex; gap:8px; align-items:center; position:relative; z-index:1;}
    .iconbtn{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.12);
      color:white;
      cursor:pointer;
      display:grid; place-items:center;
      transition: transform .12s ease, background .12s ease;
      user-select:none;
    }
    .iconbtn:hover{transform: translateY(-1px); background: rgba(255,255,255,.18)}
    .iconbtn:active{transform: translateY(0px)}

    .body{
      padding:14px;
      background: linear-gradient(180deg, #ffffff, #ffffff 62%, #f8fafc);
    }
    .card{
      border:1px solid var(--line);
      background: white;
      border-radius: 16px;
      padding:14px;
      box-shadow: 0 8px 22px rgba(2,6,23,.06);
      margin-bottom:12px;
    }
    .banner{
      border:1px solid rgba(226,232,240,.9);
      background: linear-gradient(135deg, rgba(30,78,216,.10), rgba(14,165,233,.10));
      border-radius: 16px;
      padding:12px 12px;
      margin-bottom:12px;
    }
    .banner b{color:var(--text)}
    .banner .sub{color:var(--muted); font-size:12.5px; margin-top:4px; line-height:1.35;}
    .banner .ctaRow{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;}
    .pill{
      border:1px solid var(--line);
      background:white;
      border-radius:999px;
      padding:8px 10px;
      font-weight:800;
      font-size:12.5px;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      display:inline-flex; align-items:center; gap:8px;
    }
    .pill:hover{transform: translateY(-1px); background:#f1f5f9; border-color:#cbd5e1}
    .pill.primary{
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      color:white;
      border-color: transparent;
    }
    .pill.primary:hover{background: linear-gradient(135deg, #1d4ed8, #0284c7)}

    .card h3{margin:0 0 6px 0; font-size:15px; color:var(--text);}
    .meta{color:var(--muted); font-size:12.5px; line-height:1.35;}
    .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px;}
    .chip{
      border:1px solid var(--line);
      background: var(--soft);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:800;
      color:var(--text);
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      user-select:none;
      flex:1 1 calc(50% - 8px);
      justify-content:center;
      display:flex; gap:8px; align-items:center;
      min-height:44px;
    }
    .chip:hover{transform: translateY(-1px); border-color:#cbd5e1; background:#eef2ff}

    .chat{
      height: 330px;
      overflow:auto;
      padding: 10px;
      background: #f8fafc;
      border:1px solid var(--line);
      border-radius: 16px;
      position:relative;
    }

    .typing{
      position:absolute;
      bottom:10px;
      left:10px;
      background:white;
      border:1px solid var(--line);
      border-radius: 999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      box-shadow: 0 6px 16px rgba(2,6,23,.05);
      display:none;
      align-items:center;
      gap:8px;
    }
    .dots{display:inline-flex; gap:3px;}
    .dots span{
      width:5px; height:5px; border-radius:50%;
      background:#94a3b8;
      opacity:.4;
      animation: bounce 1.1s infinite;
    }
    .dots span:nth-child(2){animation-delay:.15s}
    .dots span:nth-child(3){animation-delay:.30s}
    @keyframes bounce{
      0%,100%{transform: translateY(0); opacity:.35}
      50%{transform: translateY(-3px); opacity:.9}
    }

    .msg{display:flex; gap:10px; margin: 10px 0; align-items:flex-end;}
    .bubble{
      max-width: 82%;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background:white;
      color: var(--text);
      box-shadow: 0 8px 18px rgba(2,6,23,.05);
      font-size: 13.5px;
      line-height: 1.35;
      white-space: pre-line;
    }
    .msg.bot .bubble{border-left: 4px solid var(--brand)}
    .msg.user{justify-content:flex-end}
    .msg.user .bubble{
      background: linear-gradient(135deg, #dbeafe, #eef2ff);
      border-left: 4px solid #60a5fa;
    }

    .tiny{
      font-size:11px;
      color:var(--muted);
      margin-top:6px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .row{display:flex; gap:10px; margin-top:10px;}
    .row .btn{flex:1;}

    .btn{
      border:1px solid var(--line);
      background: white;
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight:900;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
      min-height:44px;
    }
    .btn:hover{transform: translateY(-1px); background:#f1f5f9; border-color:#cbd5e1}
    .btn.primary{
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      color:white;
      border-color: transparent;
    }
    .btn.primary:hover{background: linear-gradient(135deg, #1d4ed8, #0284c7)}
    .btn.danger{
      background: linear-gradient(135deg, #ef4444, #f97316);
      color:white;
      border-color: transparent;
    }
    .btn.danger:hover{filter: brightness(1.02)}

    .composer{display:flex; gap:10px; margin-top:10px; align-items:center;}
    input[type="text"]{
      flex:1;
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 14px;
      outline:none;
      background:white;
    }
    input[type="text"]:focus{border-color:#93c5fd; box-shadow:0 0 0 4px rgba(147,197,253,.25)}
    .send{width:96px;}

    .footerNote{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: white;
      font-size:12px;
      color:var(--muted);
    }
    .linklike{
      color: var(--brand);
      font-weight:900;
      cursor:pointer;
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .hr{height:1px; background: var(--line); margin:10px 0;}
    .mini{font-size:12px; color:var(--muted); margin-top:6px;}
    .hidden{display:none !important;}
  </style>
</head>

<body>
  <div class="wrap" role="application" aria-label="EmaBot Asistente Virtual">
    <div class="topbar">
      <div class="brand">
        <div class="avatar" aria-hidden="true">ğŸ¤–</div>
        <div class="title">
          <b>EmaBot â€“ Asistente Virtual</b>
          <small><span class="dot" aria-hidden="true"></span><span id="schoolName">Colegio Integral Emanuel</span></small>
        </div>
      </div>
      <div class="actions">
        <button class="iconbtn" id="btnVoice" title="Voz: activar/desactivar" aria-label="Voz">ğŸ”Š</button>
        <button class="iconbtn" id="btnReset" title="Reiniciar" aria-label="Reiniciar">â†»</button>
      </div>
    </div>

    <div class="body">
      <!-- Banner impactante (CTA) -->
      <div class="banner">
        <b>âœ¨ Asistencia rÃ¡pida, clara y guiada</b>
        <div class="sub">
          Selecciona una opciÃ³n o escribe tu consulta. Si la duda es muy especÃ­fica, te conecto con administraciÃ³n en un clic.
        </div>
        <div class="ctaRow">
          <div class="pill primary" id="ctaEnroll">ğŸ“ MatrÃ­cula en 1 minuto</div>
          <div class="pill" id="ctaMaps">ğŸ“ Abrir Google Maps</div>
          <div class="pill" id="ctaCall">ğŸ“ Llamar ahora</div>
        </div>
      </div>

      <div class="card" id="introCard">
        <h3>ğŸŒŸ Â¡Bienvenido(a)!</h3>
        <div class="meta">
          Soy <b>EmaBot</b>, tu asistente virtual del <b>Colegio Integral Emanuel</b>.<br/>
          âœ… Respondo rÃ¡pido â€¢ âœ… Te guÃ­o paso a paso â€¢ âœ… Puedo hablar y escribir<br/><br/>
          â° <b>Horario de atenciÃ³n:</b> <span id="officeHours"></span>
        </div>

        <div class="chips" id="roleChips">
          <div class="chip" data-role="padre"><span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span><span>Padre/Madre</span></div>
          <div class="chip" data-role="estudiante"><span>ğŸ‘©â€ğŸ“</span><span>Estudiante</span></div>
          <div class="chip" data-role="docente"><span>ğŸ‘©â€ğŸ«</span><span>Docente</span></div>
          <div class="chip" data-role="visitante"><span>ğŸ‘‹</span><span>Visitante</span></div>
        </div>

        <div class="mini">Selecciona tu perfil para recibir respuestas adaptadas.</div>
      </div>

      <div class="chat" id="chat" aria-live="polite" aria-label="ConversaciÃ³n">
        <div class="typing" id="typing">
          <span><b>EmaBot</b> estÃ¡ escribiendo</span>
          <span class="dots" aria-hidden="true"><span></span><span></span><span></span></span>
        </div>
      </div>

      <div class="row" id="quickActions">
        <button class="btn" data-action="matricula">ğŸ“ Quiero matrÃ­cula</button>
        <button class="btn" data-action="horarios">â° Ver horarios</button>
      </div>
      <div class="row">
        <button class="btn" data-action="ubicacion">ğŸ“ CÃ³mo llegar</button>
        <button class="btn" data-action="oferta">ğŸ“š Oferta acadÃ©mica</button>
      </div>
      <div class="row">
        <button class="btn" data-action="contacto">ğŸ“ Contacto</button>
        <button class="btn danger" data-action="humano">ğŸ§‘â€ğŸ’¼ Hablar con administraciÃ³n</button>
      </div>

      <div class="composer" aria-label="Escribir mensaje">
        <input id="input" type="text" placeholder="Escribe tu consulta aquÃ­â€¦" autocomplete="off" />
        <button class="btn primary send" id="sendBtn">Enviar</button>
      </div>

      <div class="footerNote">
        <span class="badge">ğŸ§  IntenciÃ³n: <b id="intentNow" style="color:#0f172a; margin-left:6px;">â€”</b></span>
        <span class="badge">ğŸ‘¤ Perfil: <b id="roleNow" style="color:#0f172a; margin-left:6px;">â€”</b></span>
        <span class="badge">ğŸ“Š <span class="linklike" id="showStats">Ver mÃ©tricas</span></span>
      </div>

      <div class="card hidden" id="statsCard">
        <h3>ğŸ“Š MÃ©tricas locales (demo)</h3>
        <div class="meta" id="statsBody"></div>
        <div class="hr"></div>
        <button class="btn" id="clearStats">Borrar mÃ©tricas</button>
      </div>

      <div class="mini">
        ğŸ« Este asistente brinda orientaciÃ³n informativa y no reemplaza la atenciÃ³n directa del colegio.
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIGURACIÃ“N RÃPIDA
   ========================= */
const CONFIG = {
  schoolName: "Colegio Integral Emanuel",
  officeHours: "Lunes a Viernes | 7:00 a.m. â€“ 3:00 p.m.",

  // âœ… CONTACTO (tu requisito)
  contactPhoneDisplay: "58057682",
  // Para WhatsApp web suele ser mejor con cÃ³digo paÃ­s. (Nicaragua 505)
  whatsappNumber: "50558057682",

  // âœ… MAPS: pega aquÃ­ tu enlace real de Google Maps
  mapsLink: "https://maps.app.goo.gl/PLdAiWjSFv9Y2ubG8",

  // InformaciÃ³n editable
  email: "colegio@ejemplo.com",
  addressText: "(De MaxipalÃ­, 25 varas al norte, Matagalpa 61000).",

  enrollmentInfo: {
    general: [
      "âœ… Requisitos comunes: Partida de nacimiento, cÃ©dula del tutor, rÃ©cord de notas (si aplica), 2 fotos tamaÃ±o carnet.",
      "âœ… Proceso: 1) Solicitud 2) RevisiÃ³n de requisitos 3) Pago 4) ConfirmaciÃ³n de cupo."
    ],
    niveles: {
      preescolar: ["ğŸ‘¶ Preescolar: cupos limitados. Recomendado iniciar trÃ¡mite con anticipaciÃ³n."],
      primaria: ["ğŸ“˜ Primaria: se solicita rÃ©cord de notas (si viene de otro centro) y entrevista breve con tutor."],
      secundaria: ["ğŸ“— Secundaria: rÃ©cord de notas + entrevista acadÃ©mica (segÃºn grado)."]
    }
  },
  academicOffer: [
    "ğŸ“š Niveles: Preescolar â€¢ Primaria â€¢ Secundaria",
    "ğŸ§© Actividades: deportes, actividades culturales, refuerzo acadÃ©mico (segÃºn plan del centro)."
  ]
};

/* =========================
   ESTADO (memoria corta)
   ========================= */
const state = {
  role: null,
  lastIntent: null,
  pendingSlot: null,
  voiceEnabled: true,
  greeted: false
};

/* =========================
   UTILIDADES
   ========================= */
const $ = (sel) => document.querySelector(sel);
const chat = $("#chat");
const input = $("#input");
const intentNow = $("#intentNow");
const roleNow = $("#roleNow");
const typing = $("#typing");

$("#schoolName").textContent = CONFIG.schoolName;
$("#officeHours").textContent = CONFIG.officeHours;

function scrollDown(){
  chat.scrollTop = chat.scrollHeight;
}

function showTyping(ms=700){
  typing.style.display = "inline-flex";
  scrollDown();
  setTimeout(() => typing.style.display = "none", ms);
}

function addMsg(text, who="bot"){
  const row = document.createElement("div");
  row.className = `msg ${who}`;
  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.textContent = text;
  row.appendChild(bubble);
  chat.appendChild(row);

  if (who === "bot") {
    const tiny = document.createElement("div");
    tiny.className = "tiny";
    tiny.innerHTML = `
      <span>Â¿Te sirviÃ³ esta respuesta?</span>
      <span class="linklike" data-feedback="up">ğŸ‘ SÃ­</span>
      <span class="linklike" data-feedback="down">ğŸ‘ No</span>
      <span class="linklike" data-action="humano">ğŸ§‘â€ğŸ’¼ Hablar con administraciÃ³n</span>
    `;
    row.appendChild(tiny);
  }

  scrollDown();
}

function speak(text){
  if(!state.voiceEnabled) return;
  if(!("speechSynthesis" in window)) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "es-ES";
  u.rate = 1.02;
  u.pitch = 1.0;
  window.speechSynthesis.speak(u);
}

/* =========================
   MÃ‰TRICAS (locales demo)
   ========================= */
function metricsKey(){ return "emabot_metrics_v2"; }

function loadMetrics(){
  try { return JSON.parse(localStorage.getItem(metricsKey())) || { intents:{}, feedback:{up:0,down:0}, roleCount:{} }; }
  catch { return { intents:{}, feedback:{up:0,down:0}, roleCount:{} }; }
}
function saveMetrics(m){ localStorage.setItem(metricsKey(), JSON.stringify(m)); }
function bumpIntent(intent){
  const m = loadMetrics();
  m.intents[intent] = (m.intents[intent] || 0) + 1;
  saveMetrics(m);
}
function bumpRole(role){
  const m = loadMetrics();
  m.roleCount[role] = (m.roleCount[role] || 0) + 1;
  saveMetrics(m);
}
function bumpFeedback(type){
  const m = loadMetrics();
  m.feedback[type] = (m.feedback[type] || 0) + 1;
  saveMetrics(m);
}

/* =========================
   INTENCIÃ“N (keywords)
   ========================= */
const INTENTS = [
  { name:"matricula",  keys:["matricula","matrÃ­cula","inscripciÃ³n","inscripcion","requisitos","cupo","precio","arancel","pago"] },
  { name:"horarios",   keys:["horario","horarios","entrada","salida","turno","atenciÃ³n","atencion"] },
  { name:"ubicacion",  keys:["ubicaciÃ³n","ubicacion","direcciÃ³n","direccion","como llegar","mapa","donde queda"] },
  { name:"oferta",     keys:["oferta","niveles","preescolar","primaria","secundaria","grados","materias","programa"] },
  { name:"contacto",   keys:["contacto","telÃ©fono","telefono","whatsapp","correo","email","llamar","escribir"] },
  { name:"humano",     keys:["administraciÃ³n","administracion","secretarÃ­a","secretaria","hablar con","persona","humano","director","coordinaciÃ³n"] }
];

function detectIntent(text){
  const t = (text||"").toLowerCase();
  for(const it of INTENTS){
    for(const k of it.keys){
      if(t.includes(k)) return it.name;
    }
  }
  return "desconocido";
}

/* =========================
   RESPUESTAS + ESCALAMIENTO
   ========================= */
function setIntent(intent){
  state.lastIntent = intent;
  intentNow.textContent = intent;
  bumpIntent(intent);
}
function setRole(role){
  state.role = role;
  roleNow.textContent = role;
  bumpRole(role);
}
function rolePrefix(){
  if(state.role === "padre") return "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§";
  if(state.role === "estudiante") return "ğŸ‘©â€ğŸ“";
  if(state.role === "docente") return "ğŸ‘©â€ğŸ«";
  if(state.role === "visitante") return "ğŸ‘‹";
  return "ğŸ¤–";
}

function openWhatsApp(){
  window.open(`https://wa.me/${CONFIG.whatsappNumber}`, "_blank");
}
function callPhone(){
  window.location.href = `tel:${CONFIG.contactPhoneDisplay}`;
}

function escalateToHuman(reason=""){
  setIntent("humano");
  showTyping(650);
  const msg =
`${rolePrefix()} ğŸ§‘â€ğŸ’¼ Te conecto con administraciÃ³n.

ğŸ“ TelÃ©fono: ${CONFIG.contactPhoneDisplay}
ğŸ’¬ WhatsApp: https://wa.me/${CONFIG.whatsappNumber}

${reason ? "ğŸ“Œ Motivo: " + reason + "\n" : ""}
âœ… Consejo: escribe tu consulta en WhatsApp para atenciÃ³n mÃ¡s rÃ¡pida.`;
  addMsg(msg);
  speak("Te conecto con administraciÃ³n. Te comparto el nÃºmero de telÃ©fono y WhatsApp.");
}

function askLevelForEnrollment(){
  state.pendingSlot = "nivel";
  showTyping(650);
  addMsg(`${rolePrefix()} Para ayudarte mejor con matrÃ­cula, Â¿para quÃ© nivel necesitas informaciÃ³n?\n\n1) Preescolar\n2) Primaria\n3) Secundaria\n\nPuedes escribir: "Primaria" por ejemplo.`);
  speak("Para ayudarte con matrÃ­cula, dime el nivel: preescolar, primaria o secundaria.");
}
function normalizeLevel(t){
  const s = (t||"").toLowerCase().trim();
  if(s.includes("pre") || s === "1") return "preescolar";
  if(s.includes("prim") || s === "2") return "primaria";
  if(s.includes("sec") || s === "3") return "secundaria";
  return null;
}

function suggestNext(){
  showTyping(500);
  addMsg(`ğŸ‘‰ Â¿En quÃ© mÃ¡s puedo ayudarte?\n1) MatrÃ­cula\n2) Horarios\n3) UbicaciÃ³n\n4) Contacto\n5) Hablar con administraciÃ³n\n\nEscribe el nÃºmero o la palabra.`);
}

function respond(intent, userText=""){
  setIntent(intent);

  // Si no hay rol, pedirlo
  if(!state.role){
    showTyping(600);
    addMsg("Antes de continuar ğŸ˜Š selecciona tu perfil: Padre/Madre, Estudiante, Docente o Visitante.");
    speak("Antes de continuar, selecciona tu perfil.");
    return;
  }

  // Resolver slot pendiente
  if(state.pendingSlot === "nivel"){
    const lvl = normalizeLevel(userText);
    if(!lvl){
      // Si no entiende el nivel: escalar directo (tu requisito)
      return escalateToHuman("No se pudo identificar el nivel de matrÃ­cula (preescolar/primaria/secundaria).");
    }
    state.pendingSlot = null;
    showTyping(700);
    const general = CONFIG.enrollmentInfo.general.join("\n");
    const specific = (CONFIG.enrollmentInfo.niveles[lvl] || []).join("\n");
    addMsg(`${rolePrefix()} ğŸ“Œ MatrÃ­cula â€“ ${lvl.toUpperCase()}\n\n${general}\n${specific}\n\nÂ¿Deseas que te indique los pasos exactos o prefieres hablar con administraciÃ³n?`);
    speak(`MatrÃ­cula para ${lvl}. Te comparto requisitos y proceso.`);
    suggestNext();
    return;
  }

  // Intenciones
  if(intent === "matricula"){
    return askLevelForEnrollment();
  }

  if(intent === "horarios"){
    showTyping(650);
    addMsg(`${rolePrefix()} â° Horario de atenciÃ³n\n\n${CONFIG.officeHours}\n\nÂ¿Deseas tambiÃ©n horarios de clases por nivel?`);
    speak("Horario de atenciÃ³n: lunes a viernes de siete a tres.");
    suggestNext();
    return;
  }

  if(intent === "ubicacion"){
    showTyping(650);
    addMsg(`${rolePrefix()} ğŸ“ UbicaciÃ³n del colegio\n\n${CONFIG.addressText}\n\nğŸ—ºï¸ Google Maps: ${CONFIG.mapsLink}\n\nÂ¿Quieres que te dÃ© puntos de referencia para llegar mÃ¡s fÃ¡cil?`);
    speak("Te comparto la ubicaciÃ³n del colegio y el enlace de Google Maps.");
    suggestNext();
    return;
  }

  if(intent === "oferta"){
    showTyping(650);
    addMsg(`${rolePrefix()} ğŸ“š Oferta acadÃ©mica\n\n${CONFIG.academicOffer.join("\n")}\n\nÂ¿Sobre quÃ© nivel deseas mÃ¡s detalles: Preescolar, Primaria o Secundaria?`);
    speak("Te comparto la oferta acadÃ©mica. Â¿QuÃ© nivel deseas conocer?");
    suggestNext();
    return;
  }

  if(intent === "contacto"){
    showTyping(650);
    addMsg(`${rolePrefix()} ğŸ“ Contacto\n\nğŸ“ TelÃ©fono: ${CONFIG.contactPhoneDisplay}\nğŸ’¬ WhatsApp: https://wa.me/${CONFIG.whatsappNumber}\nâœ‰ï¸ Correo: ${CONFIG.email}\n\nÂ¿Prefieres llamar o escribir por WhatsApp?`);
    speak("Te comparto el contacto por telÃ©fono, WhatsApp y correo.");
    suggestNext();
    return;
  }

  if(intent === "humano"){
    return escalateToHuman("Solicitud directa de atenciÃ³n humana.");
  }

  // âœ… Tu requisito: si NO sabe / NO entiende â†’ enviar a contacto
  return escalateToHuman("El asistente no encontrÃ³ una respuesta segura para tu consulta.");
}

/* =========================
   ARRANQUE
   ========================= */
function bootstrapHello(){
  if(state.greeted) return;
  state.greeted = true;
  showTyping(650);
  addMsg("ğŸŒŸ Â¡Hola! Soy EmaBot. Estoy en lÃ­nea ğŸŸ¢\nSelecciona una opciÃ³n o escribe tu consulta. Si es algo especÃ­fico, te conecto con administraciÃ³n.");
  speak("Hola. Soy EmaBot. Selecciona una opciÃ³n o escribe tu consulta.");
}

/* =========================
   EVENTOS
   ========================= */
document.addEventListener("click", (e) => {
  // Feedback
  const fb = e.target?.dataset?.feedback;
  if(fb === "up" || fb === "down"){
    bumpFeedback(fb);
    if(fb === "up"){
      showTyping(500);
      addMsg("Â¡Gracias! âœ… Me alegra haberte ayudado.");
      speak("Gracias. Me alegra haber ayudado.");
      return;
    }
    // ğŸ‘ si no sirviÃ³ â†’ escalar
    return escalateToHuman("El usuario indicÃ³ que la respuesta no fue suficiente.");
  }

  // Role chips
  const role = e.target?.closest?.(".chip")?.dataset?.role;
  if(role){
    setRole(role);
    $("#introCard").classList.add("hidden");
    bootstrapHello();
    showTyping(600);
    addMsg(`${rolePrefix()} Perfecto. Te atenderÃ© como: ${role.toUpperCase()}.\n\nÂ¿Buscas matrÃ­cula, horarios, ubicaciÃ³n, oferta acadÃ©mica o contacto?`);
    speak("Perfecto. Â¿En quÃ© puedo ayudarte?");
  }

  // Quick actions
  const action = e.target?.dataset?.action;
  if(action){
    bootstrapHello();
    respond(action);
  }

  // CTA Banner
  if(e.target?.id === "ctaEnroll"){
    bootstrapHello();
    respond("matricula");
  }
  if(e.target?.id === "ctaMaps"){
    if(CONFIG.mapsLink && !CONFIG.mapsLink.includes("PEGA_AQUI")){
      window.open(CONFIG.mapsLink, "_blank");
    } else {
      bootstrapHello();
      escalateToHuman("Falta configurar el enlace de Google Maps en el sistema.");
    }
  }
  if(e.target?.id === "ctaCall"){
    callPhone();
  }

  // Stats
  if(e.target?.id === "showStats"){
    const card = $("#statsCard");
    card.classList.toggle("hidden");
    if(!card.classList.contains("hidden")){
      const m = loadMetrics();
      const intents = Object.entries(m.intents).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`â€¢ ${k}: ${v}`).join("\n") || "â€”";
      const roles = Object.entries(m.roleCount).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`â€¢ ${k}: ${v}`).join("\n") || "â€”";
      $("#statsBody").textContent =
        `Intenciones consultadas:\n${intents}\n\nPerfiles seleccionados:\n${roles}\n\nFeedback:\nâ€¢ ğŸ‘ SÃ­: ${m.feedback.up}\nâ€¢ ğŸ‘ No: ${m.feedback.down}`;
      scrollDown();
    }
  }

  if(e.target?.id === "clearStats"){
    localStorage.removeItem(metricsKey());
    $("#statsBody").textContent = "MÃ©tricas borradas.";
  }

  // Atajo â€œhablar con administraciÃ³nâ€ dentro del tiny
  if(e.target?.dataset?.action === "humano"){
    bootstrapHello();
    respond("humano");
  }
});

$("#sendBtn").addEventListener("click", sendUserText);
input.addEventListener("keydown", (e) => {
  if(e.key === "Enter") sendUserText();
});

function sendUserText(){
  const text = input.value.trim();
  if(!text) return;
  bootstrapHello();
  addMsg(text, "user");
  input.value = "";

  // pendiente slot
  if(state.pendingSlot){
    return respond(state.lastIntent || "desconocido", text);
  }

  // atajos
  const t = text.toLowerCase();
  if(["1","matricula","matrÃ­cula"].includes(t)) return respond("matricula", text);
  if(["2","horarios","horario"].includes(t)) return respond("horarios", text);
  if(["3","ubicacion","ubicaciÃ³n","mapa"].includes(t)) return respond("ubicacion", text);
  if(["4","contacto","whatsapp","correo"].includes(t)) return respond("contacto", text);
  if(["5","administracion","administraciÃ³n","humano","persona"].includes(t)) return respond("humano", text);

  // detecciÃ³n intenciÃ³n
  const intent = detectIntent(text);
  respond(intent, text);
}

/* Voz */
$("#btnVoice").addEventListener("click", () => {
  state.voiceEnabled = !state.voiceEnabled;
  $("#btnVoice").textContent = state.voiceEnabled ? "ğŸ”Š" : "ğŸ”‡";
  showTyping(400);
  addMsg(state.voiceEnabled ? "ğŸ”Š Voz activada." : "ğŸ”‡ Voz desactivada.");
  if(state.voiceEnabled) speak("Voz activada.");
});

/* Reset */
$("#btnReset").addEventListener("click", () => {
  chat.innerHTML = `<div class="typing" id="typing">
    <span><b>EmaBot</b> estÃ¡ escribiendo</span>
    <span class="dots" aria-hidden="true"><span></span><span></span><span></span></span>
  </div>`;
  // Reasignar typing (porque recreamos)
  window.typing = $("#typing");

  state.role = null;
  state.lastIntent = null;
  state.pendingSlot = null;
  state.greeted = false;
  intentNow.textContent = "â€”";
  roleNow.textContent = "â€”";
  $("#introCard").classList.remove("hidden");
  showTyping(550);
  addMsg("â†» Reiniciado. Selecciona tu perfil para comenzar.");
  speak("Reiniciado. Selecciona tu perfil para comenzar.");
});

/* Saludo automÃ¡tico */
window.addEventListener("load", () => {
  addMsg("âœ¨ EmaBot estÃ¡ listo. Selecciona tu perfil para iniciar.");
  if(state.voiceEnabled) speak("EmaBot estÃ¡ listo. Selecciona tu perfil para iniciar.");
});
</script>
</body>
</html>
