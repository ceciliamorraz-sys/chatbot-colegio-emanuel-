<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EmaBot - Colegio Integral Emanuel</title>
  <style>
    body { font-family: Arial, sans-serif; }

    #chat-btn{
      position: fixed; bottom: 20px; right: 20px;
      background:#1f6feb; color:#fff; border:none;
      border-radius:50%; width:60px; height:60px;
      font-size:26px; cursor:pointer;
      box-shadow:0 4px 10px rgba(0,0,0,0.3);
      z-index: 99999;
    }

    #chat-box{
      display:none;
      position: fixed; bottom: 90px; right: 20px;
      width: 360px; max-width: calc(100vw - 40px);
      height: 520px; max-height: calc(100vh - 140px);
      background:#fff; border-radius:12px;
      box-shadow:0 8px 18px rgba(0,0,0,0.25);
      overflow:hidden;
      z-index: 99999;
    }

    #chat-header{
      background:#1f6feb; color:#fff; padding:12px 14px;
      font-weight:bold; display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
    }
    #chat-header .title { display:flex; align-items:center; gap:8px; }
    #chat-header .actions { display:flex; gap:10px; align-items:center; }
    #chat-header button{
      background: transparent; border:none; color:#fff; font-size:18px; cursor:pointer;
    }

    #chat-messages{
      padding: 12px;
      height: 340px;
      overflow-y:auto;
      background:#f4f6f8;
      font-size:14px;
    }

    .msg{
      background:#fff;
      padding:10px 12px;
      margin-bottom:10px;
      border-radius:10px;
      line-height:1.35;
      white-space: pre-wrap;
    }
    .user{ background:#dff3ff; text-align:right; }

    #chat-footer{
      padding: 10px;
      border-top: 1px solid #e5e7eb;
      background:#fff;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }

    .row{ display:flex; gap:10px; align-items:center; }

    #user-input{
      flex:1;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #d1d5db;
      outline:none;
      font-size:14px;
    }

    .btn{
      padding:10px 12px;
      border:none;
      border-radius:10px;
      background:#1f6feb;
      color:#fff;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
    }

    #faq{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .faq-btn{
      padding:10px 10px;
      border:1px solid #d1d5db;
      border-radius:10px;
      background:#fff;
      cursor:pointer;
      text-align:left;
      font-size:14px;
    }
    .faq-btn:hover{ background:#f3f4f6; }

    @media (max-width: 420px){
      #chat-box{ width: calc(100vw - 24px); right: 12px; }
      #chat-btn{ right: 12px; }
      #faq{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>

<button id="chat-btn" aria-label="Abrir chat">üí¨</button>

<div id="chat-box" role="dialog" aria-label="Chat EmaBot">
  <div id="chat-header">
    <div class="title">ü§ñ <span>EmaBot ‚Äì Colegio Integral Emanuel</span></div>
    <div class="actions">
      <button id="voice-toggle" title="Activar/Desactivar voz" aria-label="Voz">üîä</button>
      <button onclick="toggleChat()" aria-label="Cerrar">‚úñ</button>
    </div>
  </div>

  <div id="chat-messages"></div>

  <div id="chat-footer">
    <div id="faq">
      <button class="faq-btn" onclick="answerFAQ('direccion')">üìç Direcci√≥n</button>
      <button class="faq-btn" onclick="answerFAQ('mensualidad')">üìÖ Mensualidad</button>
      <button class="faq-btn" onclick="answerFAQ('matricula')">üíµ Matr√≠cula</button>
      <button class="faq-btn" onclick="answerFAQ('ofrece')">üéì ¬øQu√© ofrece?</button>
      <button class="faq-btn" onclick="goWhatsApp('Hola, deseo informaci√≥n del Colegio Integral Emanuel.')">üì≤ WhatsApp</button>
      <button class="faq-btn" onclick="showHorario()">‚è∞ Horario</button>
    </div>

    <div class="row">
      <input id="user-input" placeholder="Escribe tu pregunta..." />
      <button class="btn" onclick="handleUserQuestion()">Enviar</button>
    </div>
  </div>
</div>

<script>
  // ========= CONFIG =========
  const WHATSAPP_NUMBER = "50588543012";
  const OPEN_HOUR = 7;
  const CLOSE_HOUR = 15;

  const saludo = [
    "üëã Bienvenido al Colegio Integral Emanuel.",
    "Soy EmaBot, el asistente virtual institucional.",
    "",
    "‚è∞ Horario de atenci√≥n: Lunes a Viernes, 7:00 a.m. a 3:00 p.m.",
    "",
    "üìñ El texto b√≠blico de hoy es:",
    "‚ÄúInstruye al ni√±o en su camino, y aun cuando fuere viejo no se apartar√° de √©l.‚Äù",
    "(Proverbios 22:6)",
    "",
    "üòä ¬øEn qu√© m√°s podemos ayudarte?"
  ].join("\n");

  const cierre = "üôè Bendiciones, quedamos a su disposici√≥n.";

  // ========= ELEMENTS =========
  const chatBtn = document.getElementById("chat-btn");
  const chatBox = document.getElementById("chat-box");
  const messages = document.getElementById("chat-messages");
  const inputEl = document.getElementById("user-input");
  const voiceToggleBtn = document.getElementById("voice-toggle");

  chatBtn.onclick = toggleChat;

  let greeted = false;
  let voiceEnabled = true; // ‚úÖ VOZ ACTIVADA POR DEFECTO

  // ========= VOZ (TTS) =========
  function speak(text){
    if (!voiceEnabled) return;

    if (!("speechSynthesis" in window)) {
      // Si no hay soporte, no hacemos nada
      return;
    }

    // Evita que se encime una voz con otra
    window.speechSynthesis.cancel();

    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "es-ES";
    utter.rate = 1;   // velocidad normal
    utter.pitch = 1;  // tono normal

    window.speechSynthesis.speak(utter);
  }

  voiceToggleBtn.onclick = () => {
    voiceEnabled = !voiceEnabled;
    voiceToggleBtn.textContent = voiceEnabled ? "üîä" : "üîá";
    if (!voiceEnabled) window.speechSynthesis.cancel();
  };

  // ========= CHAT =========
  function toggleChat(){
    const isOpen = chatBox.style.display === "block";
    chatBox.style.display = isOpen ? "none" : "block";

    if (!isOpen && !greeted){
      addBotMessage(saludo, true); // ‚úÖ habla el saludo
      greeted = true;
    }
  }

  function addBotMessage(text, shouldSpeak = true){
    const div = document.createElement("div");
    div.className = "msg";
    div.textContent = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;

    // ‚úÖ Hace que el asistente hable cada respuesta del bot
    if (shouldSpeak) speak(text);
  }

  function addUserMessage(text){
    const div = document.createElement("div");
    div.className = "msg user";
    div.textContent = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  function normalizeText(text){
    return text
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .trim();
  }

  // ========= HORARIO =========
  function isWithinBusinessHours(){
    const now = new Date();
    const day = now.getDay(); // 0 domingo, 1 lunes...
    const hour = now.getHours();

    const isWeekday = day >= 1 && day <= 5;
    const inHours = hour >= OPEN_HOUR && hour < CLOSE_HOUR;
    return isWeekday && inHours;
  }

  function showHorario(){
    addUserMessage("Horario");
    addBotMessage("‚è∞ Horario de atenci√≥n: Lunes a Viernes, 7:00 a.m. a 3:00 p.m.\n" + cierre);
  }

  // ========= WHATSAPP =========
  function goWhatsApp(message){
    const url = "https://wa.me/" + WHATSAPP_NUMBER + "?text=" + encodeURIComponent(message);
    window.open(url, "_blank");
  }

  function fallbackToWhatsApp(userQuestion){
    addBotMessage("No tengo esa informaci√≥n registrada a√∫n. üì≤ Te atendemos por WhatsApp.\n" + cierre);
    goWhatsApp("Hola, tengo esta consulta: " + userQuestion);
  }

  // ========= FAQ =========
  function answerFAQ(type){
    if (type === "direccion"){
      addUserMessage("Direcci√≥n");
      addBotMessage("üìç Costado Este del Maxipali, 25 varas al norte.\n" + cierre);
      return;
    }

    if (type === "mensualidad"){
      addUserMessage("Mensualidad");
      addBotMessage("üìÖ La mensualidad es de C$ 1,450.\n" + cierre);
      return;
    }

    if (type === "matricula"){
      addUserMessage("Matr√≠cula");
      addBotMessage("üíµ La informaci√≥n de matr√≠cula se brinda directamente por WhatsApp.\n" + cierre);
      goWhatsApp("Hola, deseo informaci√≥n de matr√≠cula/inscripci√≥n.");
      return;
    }

    if (type === "ofrece"){
      addUserMessage("¬øQu√© ofrece?");
      addBotMessage("üéì Ofrecemos educaci√≥n integral, formaci√≥n en valores, docentes capacitados y un ambiente seguro.\n" + cierre);
      return;
    }
  }

  // ========= PREGUNTA LIBRE =========
  function handleUserQuestion(){
    const question = (inputEl.value || "").trim();
    if (!question) return;

    addUserMessage(question);
    inputEl.value = "";

    const q = normalizeText(question);

    // Si fuera de horario ‚Üí WhatsApp
    if (!isWithinBusinessHours()){
      addBotMessage("‚è∞ En este momento estamos fuera del horario de atenci√≥n.\nüì≤ Para atenci√≥n inmediata, escr√≠benos por WhatsApp.\n" + cierre);
      goWhatsApp("Hola, escribo fuera de horario. Mi consulta es: " + question);
      return;
    }

    if (q.includes("direccion") || q.includes("ubicacion") || q.includes("donde")){
      addBotMessage("üìç Costado Este del Maxipali, 25 varas al norte.\n" + cierre);
      return;
    }
    if (q.includes("mensualidad") || q.includes("cuota")){
      addBotMessage("üìÖ La mensualidad es de C$ 1,450.\n" + cierre);
      return;
    }
    if (q.includes("matricula") || q.includes("inscripcion")){
      addBotMessage("üíµ La informaci√≥n de matr√≠cula se brinda por WhatsApp.\n" + cierre);
      goWhatsApp("Hola, deseo informaci√≥n de matr√≠cula/inscripci√≥n.");
      return;
    }
    if (q.includes("ofrece") || q.includes("servicios")){
      addBotMessage("üéì Ofrecemos educaci√≥n integral, formaci√≥n en valores y un ambiente seguro.\n" + cierre);
      return;
    }
    if (q.includes("contacto") || q.includes("telefono") || q.includes("whatsapp")){
      addBotMessage("üì≤ Te atendemos por WhatsApp.\n" + cierre);
      goWhatsApp("Hola, deseo informaci√≥n del Colegio Integral Emanuel.");
      return;
    }

    fallbackToWhatsApp(question);
  }

  // Enter para enviar
  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") handleUserQuestion();
  });
</script>

</body>
</html>
