<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EmaBot ‚Äì Asistente Virtual</title>
  <style>
    :root{
      --primary:#1e5bd8;
      --primary-2:#0f3aa6;
      --bg:#f4f7ff;
      --card:#ffffff;
      --text:#1b1f2a;
      --muted:#5d6b86;
      --line:#e6eaf3;
      --accent:#ffb020;
      --radius:16px;
      --shadow:0 12px 30px rgba(16, 40, 120, .14);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: transparent;
      color: var(--text);
    }

    /* Widget flotante */
    .fab{
      position: fixed;
      right: 18px;
      bottom: 18px;
      width: 56px;
      height: 56px;
      border-radius: 999px;
      border: none;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 22px;
    }

    .chat{
      position: fixed;
      right: 18px;
      bottom: 86px;
      width: min(380px, calc(100vw - 36px));
      height: 72vh;
      max-height: 640px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display:none;
      border:1px solid var(--line);
    }
    .chat.open{display:block}

    .chat__header{
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      color: #fff;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .boticon{
      width:34px;
      height:34px;
      border-radius: 10px;
      background: rgba(255,255,255,.16);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      flex:0 0 auto;
    }
    .brand__text{
      min-width:0;
      line-height:1.15;
    }
    .brand__title{
      font-weight: 700;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .brand__sub{
      font-size: 12px;
      opacity: .9;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .header__actions{
      display:flex;
      gap: 8px;
      align-items:center;
    }
    .iconbtn{
      border:none;
      background: rgba(255,255,255,.18);
      color:#fff;
      width: 34px;
      height: 34px;
      border-radius: 10px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 16px;
    }
    .iconbtn:hover{background: rgba(255,255,255,.26)}

    .chat__body{
      background: var(--bg);
      padding: 14px;
      height: calc(100% - 56px - 64px);
      overflow:auto;
    }

    .bubble{
      max-width: 92%;
      padding: 10px 12px;
      border-radius: 14px;
      margin: 8px 0;
      border: 1px solid var(--line);
      background:#fff;
      box-shadow: 0 6px 14px rgba(0,0,0,.06);
      font-size: 14px;
      line-height: 1.35;
    }
    .bubble.bot{border-top-left-radius: 8px}
    .bubble.user{
      margin-left:auto;
      background: #eaf1ff;
      border-color: #d5e2ff;
      border-top-right-radius: 8px;
    }
    .meta{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    .panel{
      background:#fff;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      margin: 12px 0;
    }
    .panel__title{
      font-weight: 700;
      margin: 0 0 8px;
      font-size: 13px;
      color: var(--text);
    }

    .btns{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .btn{
      border:1px solid #d6def1;
      background:#fff;
      border-radius: 12px;
      padding: 10px 10px;
      cursor:pointer;
      font-weight: 600;
      font-size: 13px;
      color: var(--text);
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:flex-start;
    }
    .btn:hover{background:#f6f9ff}
    .btn.full{grid-column: 1 / -1}

    .voicebar{
      display:flex;
      gap:10px;
      margin-top: 10px;
    }
    .voicebtn{
      flex: 1;
      border:none;
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 700;
      background: var(--primary);
      color:#fff;
    }
    .voicebtn.secondary{
      background:#fff;
      color: var(--primary);
      border:1px solid #cfe0ff;
    }
    .voicebtn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .chat__footer{
      border-top:1px solid var(--line);
      background:#fff;
      padding: 10px;
      display:flex;
      gap: 10px;
      align-items:center;
      height: 64px;
    }
    .input{
      flex:1;
      border:1px solid #d6def1;
      border-radius: 12px;
      padding: 11px 12px;
      outline:none;
      font-size: 14px;
    }
    .send{
      border:none;
      background: var(--primary);
      color:#fff;
      border-radius: 12px;
      padding: 11px 14px;
      cursor:pointer;
      font-weight: 700;
    }
    .send:hover{background: var(--primary-2)}

    .small{
      font-size:12px;
      color: var(--muted);
    }

    a{color: var(--primary); text-decoration: none}
    a:hover{text-decoration: underline}

    /* Responsive */
    @media (max-height: 560px){
      .chat{height: 78vh}
    }
  </style>
</head>
<body>

  <!-- Bot√≥n flotante -->
  <button class="fab" id="fab" aria-label="Abrir chat">üí¨</button>

  <!-- Ventana del chat -->
  <section class="chat" id="chat" aria-label="EmaBot">
    <header class="chat__header">
      <div class="brand">
        <div class="boticon">ü§ñ</div>
        <div class="brand__text">
          <div class="brand__title">EmaBot ‚Äì Asistente Virtual</div>
          <div class="brand__sub">Colegio Integral Emanuel</div>
        </div>
      </div>
      <div class="header__actions">
        <button class="iconbtn" id="toggleSound" title="Activar/desactivar lectura por voz">üîä</button>
        <button class="iconbtn" id="close" title="Cerrar">‚úï</button>
      </div>
    </header>

    <main class="chat__body" id="body"></main>

    <footer class="chat__footer">
      <input class="input" id="input" placeholder="Escriba su consulta aqu√≠..." />
      <button class="send" id="send">Enviar</button>
    </footer>
  </section>

  <script>
    /***********************
     * CONFIGURACI√ìN R√ÅPIDA
     ***********************/
    const SCHOOL = {
      name: "Colegio Integral Emanuel",
      city: "Matagalpa, Nicaragua",
      phone: "8853-3012",
      whatsapp: "50588533012", // +505 sin signos ni espacios
      email: "colegiointegralemanuel@gmail.com",
      hours: "Lunes a Viernes | 7:00 a.m. a 3:00 p.m.",
      website: "https://ceciliamorraz-sys.github.io/chatbot-colegio-emanuel-/",
      maps: "https://www.google.com/maps/search/?api=1&query=Colegio+Integral+Emanuel+Matagalpa"
    };

    /***********************
     * UTILIDADES
     ***********************/
    const $ = (id) => document.getElementById(id);
    const chat = $("chat");
    const body = $("body");
    const input = $("input");
    const fab = $("fab");
    const closeBtn = $("close");
    const sendBtn = $("send");
    const toggleSoundBtn = $("toggleSound");

    let speakEnabled = true;

    function escapeHtml(str){
      return str.replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function addBubble(text, who="bot"){
      const div = document.createElement("div");
      div.className = `bubble ${who}`;
      div.innerHTML = text; // text ya debe venir seguro si incluye HTML
      body.appendChild(div);
      body.scrollTop = body.scrollHeight;

      // Lectura por voz solo para bot
      if(who === "bot" && speakEnabled){
        speak(stripHtml(text));
      }
    }

    function stripHtml(html){
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      return (tmp.textContent || tmp.innerText || "").trim();
    }

    function speak(text){
      try{
        if(!("speechSynthesis" in window)) return;
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "es-ES";
        u.rate = 1;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      }catch(e){}
    }

    function addPanel(){
      const panel = document.createElement("div");
      panel.className = "panel";
      panel.innerHTML = `
        <div class="panel__title">Seleccione una opci√≥n o escriba su consulta</div>
        <div class="btns">
          <button class="btn" data-action="matricula">üìù Matr√≠cula</button>
          <button class="btn" data-action="horarios">‚è∞ Horarios</button>
          <button class="btn" data-action="ubicacion">üìç Ubicaci√≥n</button>
          <button class="btn" data-action="ofertas">üìö Ofertas</button>
          <button class="btn full" data-action="contacto">üìû Contacto / WhatsApp</button>
        </div>

        <div class="voicebar">
          <button class="voicebtn secondary" id="listenBtn">üéôÔ∏è Dictar pregunta</button>
          <button class="voicebtn" id="stopVoice">‚èπ Detener voz</button>
        </div>

        <div class="small" style="margin-top:10px;">
          <b>Horario de atenci√≥n administrativa:</b> ${escapeHtml(SCHOOL.hours)}
        </div>
      `;
      body.appendChild(panel);
      body.scrollTop = body.scrollHeight;

      panel.querySelectorAll("button[data-action]").forEach(btn=>{
        btn.addEventListener("click", ()=> handleAction(btn.dataset.action));
      });

      // Dictado por voz (SpeechRecognition)
      const listenBtn = panel.querySelector("#listenBtn");
      const stopVoice = panel.querySelector("#stopVoice");

      stopVoice.addEventListener("click", ()=> {
        if("speechSynthesis" in window) window.speechSynthesis.cancel();
      });

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SpeechRecognition){
        listenBtn.disabled = true;
        listenBtn.textContent = "üéôÔ∏è Dictado no disponible";
        return;
      }

      const rec = new SpeechRecognition();
      rec.lang = "es-ES";
      rec.interimResults = false;
      rec.maxAlternatives = 1;

      listenBtn.addEventListener("click", ()=>{
        try{
          rec.start();
          listenBtn.textContent = "üéôÔ∏è Escuchando...";
          listenBtn.disabled = true;
        }catch(e){
          listenBtn.disabled = false;
          listenBtn.textContent = "üéôÔ∏è Dictar pregunta";
        }
      });

      rec.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        input.value = transcript;
        listenBtn.disabled = false;
        listenBtn.textContent = "üéôÔ∏è Dictar pregunta";
        input.focus();
      };
      rec.onerror = () => {
        listenBtn.disabled = false;
        listenBtn.textContent = "üéôÔ∏è Dictar pregunta";
      };
      rec.onend = () => {
        listenBtn.disabled = false;
        listenBtn.textContent = "üéôÔ∏è Dictar pregunta";
      };
    }

    /***********************
     * RESPUESTAS
     ***********************/
    function rMatricula(){
      return `
        <b>üìù Informaci√≥n de Matr√≠cula</b><br><br>
        Para informaci√≥n sobre el proceso de matr√≠cula, requisitos y fechas disponibles, puede comunicarse con la administraci√≥n del colegio.<br><br>
        <b>üìû Tel√©fono/WhatsApp:</b> ${escapeHtml(SCHOOL.phone)}<br>
        <b>‚è∞ Atenci√≥n:</b> ${escapeHtml(SCHOOL.hours)}<br><br>
        <a href="https://wa.me/${encodeURIComponent(SCHOOL.whatsapp)}" target="_blank" rel="noopener">Abrir WhatsApp</a>
      `;
    }

    function rHorarios(){
      return `
        <b>‚è∞ Horarios de Atenci√≥n</b><br><br>
        <b>Atenci√≥n administrativa:</b><br>
        ${escapeHtml(SCHOOL.hours)}
      `;
    }

    function rUbicacion(){
      return `
        <b>üìç Ubicaci√≥n del Colegio</b><br><br>
        ${escapeHtml(SCHOOL.name)} ‚Äì ${escapeHtml(SCHOOL.city)}<br><br>
        <a href="${escapeHtml(SCHOOL.maps)}" target="_blank" rel="noopener">Ver en Google Maps</a>
      `;
    }

    function rOfertas(){
      return `
        <b>üìö Ofertas Acad√©micas</b><br><br>
        Brindamos una educaci√≥n integral basada en valores cristianos, que incluye:<br>
        ‚úî Preescolar<br>
        ‚úî Primaria<br>
        ‚úî Ingl√©s diario<br>
        ‚úî Tecnolog√≠a educativa<br>
        ‚úî Atenci√≥n psicopedag√≥gica
      `;
    }

    function rContacto(){
      return `
        <b>üìû Contacto</b><br><br>
        <b>Tel√©fono/WhatsApp:</b> ${escapeHtml(SCHOOL.phone)}<br>
        <b>Correo:</b> ${escapeHtml(SCHOOL.email)}<br><br>
        <a href="https://wa.me/${encodeURIComponent(SCHOOL.whatsapp)}" target="_blank" rel="noopener">Escribir por WhatsApp</a>
      `;
    }

    function rDefault(){
      return `
        <b>‚úÖ Gracias por su consulta.</b><br><br>
        Para ayudarle mejor, por favor ind√≠queme si necesita informaci√≥n sobre:<br>
        üìù Matr√≠cula ¬∑ ‚è∞ Horarios ¬∑ üìç Ubicaci√≥n ¬∑ üìö Ofertas ¬∑ üìû Contacto
      `;
    }

    function handleAction(action){
      switch(action){
        case "matricula": addBubble(rMatricula(), "bot"); break;
        case "horarios": addBubble(rHorarios(), "bot"); break;
        case "ubicacion": addBubble(rUbicacion(), "bot"); break;
        case "ofertas": addBubble(rOfertas(), "bot"); break;
        case "contacto": addBubble(rContacto(), "bot"); break;
        default: addBubble(rDefault(), "bot");
      }
    }

    function matchIntent(text){
      const t = text.toLowerCase();

      if(t.includes("matr") || t.includes("inscrip") || t.includes("requisit") || t.includes("pago") || t.includes("arancel")){
        return "matricula";
      }
      if(t.includes("horario") || t.includes("hora") || t.includes("atienden") || t.includes("atenci√≥n") || t.includes("atencion")){
        return "horarios";
      }
      if(t.includes("ubic") || t.includes("direc") || t.includes("donde") || t.includes("mapa") || t.includes("llegar")){
        return "ubicacion";
      }
      if(t.includes("oferta") || t.includes("prees") || t.includes("primar") || t.includes("ingles") || t.includes("tecnolog") || t.includes("psicoped")){
        return "ofertas";
      }
      if(t.includes("tel") || t.includes("whats") || t.includes("correo") || t.includes("contact")){
        return "contacto";
      }
      return null;
    }

    /***********************
     * EVENTOS
     ***********************/
    function openChat(){
      chat.classList.add("open");
      fab.style.display = "none";
      input.focus();
      if(body.childElementCount === 0){
        // Mensaje inicial
        addBubble(
          `<b>üëã Bienvenido(a) al asistente virtual del ${escapeHtml(SCHOOL.name)}.</b><br><br>
           Estoy aqu√≠ para brindarle informaci√≥n clara y oportuna sobre nuestros servicios educativos.<br><br>
           <b>‚è∞ Horario de atenci√≥n administrativa:</b><br>${escapeHtml(SCHOOL.hours)}<br><br>
           Por favor, seleccione una opci√≥n o escriba su consulta.`,
          "bot"
        );
        addPanel();
      }
    }

    function closeChat(){
      chat.classList.remove("open");
      fab.style.display = "flex";
      if("speechSynthesis" in window) window.speechSynthesis.cancel();
    }

    fab.addEventListener("click", openChat);
    closeBtn.addEventListener("click", closeChat);

    toggleSoundBtn.addEventListener("click", ()=>{
      speakEnabled = !speakEnabled;
      toggleSoundBtn.textContent = speakEnabled ? "üîä" : "üîá";
      toggleSoundBtn.title = speakEnabled ? "Desactivar lectura por voz" : "Activar lectura por voz";
      if(!speakEnabled && "speechSynthesis" in window) window.speechSynthesis.cancel();
    });

    function send(){
      const text = (input.value || "").trim();
      if(!text) return;

      addBubble(escapeHtml(text), "user");
      input.value = "";

      const intent = matchIntent(text);
      if(intent) handleAction(intent);
      else addBubble(rDefault(), "bot");
    }

    sendBtn.addEventListener("click", send);
    input.addEventListener("keydown", (e)=>{
      if(e.key === "Enter") send();
    });

    // Abre autom√°ticamente si quieres (opcional):
    // openChat();
  </script>
</body>
</html>
